# x402 Payment Integration

This project now includes x402 payment gating for beacon (tweet) creation. Users must pay 0.01 SOL to the treasury before creating a beacon.

## Features

- **Payment Gate**: All beacon creation requires 0.01 SOL payment
- **Mainnet Only**: Only Solana mainnet payments are accepted
- **Treasury Integration**: Uses existing treasury address
- **Replay Protection**: Prevents duplicate payments
- **Auto-retry**: Client automatically pays and retries on 402

## Architecture

### Backend (Vercel Serverless)
- `api/beacon.js` - Vercel serverless function with x402 middleware
- `src/lib/x402.ts` - x402 payment verification logic (TypeScript)

### Frontend
- `src/lib/x402-client.ts` - Client-side payment helper
- `src/api/send-tweet.ts` - Updated to use x402 API

## Configuration

### Environment Variables
```bash
X402_NETWORK=solana
X402_PRICE_SOL=0.01
X402_FACILITATOR_URL=your-facilitator-url-here  # Optional
PORT=3001  # Server port
```

### Treasury Address
The treasury address is configured in `src/lib/x402.ts`:
```typescript
export const TREASURY_SOL_ADDRESS = 'EpPXQsvRBvxZ9LDLDCT3NyhEN8uhfQBqi2jFei8TLT7';
```

## Usage

### Development
```bash
# Install dependencies
yarn install

# Start frontend development server
yarn dev

# The API will be available at /api/beacon when deployed to Vercel
```

### Production
The x402 integration works with your existing Vercel deployment. The frontend will make requests to your API endpoint.

## API Endpoints

### POST /api/beacon
Creates a new beacon with x402 payment verification.

**Headers:**
- `x-402-proof`: JSON proof of payment (auto-generated by client)

**Body:**
```json
{
  "topic": "string",
  "content": "string", 
  "author": "string",
  "author_display": "string" // optional
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Beacon created successfully",
  "beacon": { ... },
  "payment": {
    "transaction": "signature",
    "amount": 0.01
  }
}
```

**Response (402 Payment Required):**
```json
{
  "error": "Payment Required",
  "message": "This endpoint requires a 0.01 SOL payment",
  "payment": {
    "network": "solana",
    "recipient": "treasury-address",
    "price": { "token": "SOL", "amount": 0.01 },
    "config": { "description": "Pay 0.01 SOL to beacon (tweet)." }
  }
}
```

## Payment Flow

1. User clicks "Beacon" button
2. Frontend calls `/api/beacon` without proof
3. Server responds with 402 and payment details
4. Client creates 0.01 SOL transaction to treasury
5. Client retries with payment proof in `x-402-proof` header
6. Server verifies payment and creates beacon

## Security Features

- **Mainnet Only**: Rejects devnet/testnet payments
- **Amount Verification**: Ensures exactly 0.01 SOL payment
- **Transaction Confirmation**: Waits for confirmed transactions
- **Replay Protection**: Caches verified payments
- **Treasury Validation**: Verifies payment to correct address

## Error Handling

The client handles various error scenarios:
- Wallet not connected
- Insufficient funds
- Transaction rejected by user
- Network errors
- Payment verification failures

## Customization

### Change Payment Amount
Update `X402_PRICE_SOL` in environment variables and `X402_CONFIG.priceSOL` in `src/lib/x402.ts`.

### Change Treasury Address
Update `TREASURY_SOL_ADDRESS` in `src/lib/x402.ts`.

### Add Facilitator
Set `X402_FACILITATOR_URL` environment variable for external payment processing.

## Troubleshooting

### Common Issues

1. **402 Payment Required**: Normal flow, client will auto-pay
2. **Payment Verification Failed**: Check transaction is confirmed and to correct address
3. **Network Error**: Ensure using mainnet RPC
4. **Wallet Issues**: Check wallet connection and balance

### Debug Mode
Enable console logging by checking browser dev tools for detailed payment flow logs.

## Integration Notes

- Uses existing QuickNode RPC (unchanged)
- Uses existing Supabase database (unchanged)  
- Uses existing treasury address (unchanged)
- Minimal changes to existing codebase
- TypeScript strict mode compliant
